{"version":3,"sources":["../src/IPC/ClusterIPC.ts"],"names":[],"mappings":"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","file":"ClusterIPC.js","sourcesContent":["import { EventEmitter } from 'events';\r\nimport { Node, NodeMessage, NodeSocket } from 'veza';\r\nimport { Client, Util } from 'discord.js';\r\nimport { IPCEvents } from '../Util/Constants';\r\n\r\nexport class ClusterIPC extends EventEmitter {\r\n\tpublic nodeSocket?: NodeSocket;\r\n\tpublic client: Client;\r\n\tpublic node: Node;\r\n\r\n\tconstructor(discordClient: Client, public id: number, public socket: string | number) {\r\n\t\tsuper();\r\n\t\tthis.client = discordClient;\r\n\t\tthis.node = new Node(`Cluster ${this.id}`)\r\n\t\t\t.on('error', error => this.emit('error', error))\r\n\t\t\t.on('client.disconnect', client => this.emit('warn', `[IPC] Disconnected from ${client.name}`))\r\n\t\t\t.on('client.ready', client => this.emit('debug', `[IPC] Connected to: ${client.name}`))\r\n\t\t\t.on('message', this._message.bind(this));\r\n\t}\r\n\r\n\tpublic async broadcast<T>(script: string | Function): Promise<T[]> {\r\n\t\tscript = typeof script === 'function' ? `(${script})(this)` : script;\r\n\t\tconst { success, d } = await this.server.send({ op: IPCEvents.BROADCAST, d: script });\r\n\t\tif (!success) throw Util.makeError(d);\r\n\t\treturn d;\r\n\t}\r\n\r\n\tpublic async masterEval<T>(script: string | Function): Promise<T> {\r\n\t\tscript = typeof script === 'function' ? `(${script})(this)` : script;\r\n\t\tconst { success, d } = await this.server.send({ op: IPCEvents.MASTEREVAL, d: script });\r\n\t\tif (!success) throw Util.makeError(d);\r\n\t\treturn d;\r\n\t}\r\n\r\n\tpublic async init() {\r\n\t\tthis.nodeSocket = await this.node.connectTo('Master', String(this.socket));\r\n\t}\r\n\r\n\tpublic get server() {\r\n\t\treturn this.nodeSocket!;\r\n\t}\r\n\r\n\tprivate _eval(script: string): string {\r\n\t\tconst client: any = this.client;\r\n\t\treturn client._eval(script);\r\n\t}\r\n\r\n\tprivate async _message(message: NodeMessage) {\r\n\t\tconst { op, d, route } = message.data;\r\n\t\tif (op === IPCEvents.EVAL) {\r\n\t\t\ttry {\r\n\t\t\t\tmessage.reply({ success: true, d: await this._eval(d) });\r\n\t\t\t} catch (error) {\r\n\t\t\t\tmessage.reply({ success: false, d: { name: error.name, message: error.message, stack: error.stack } });\r\n\t\t\t}\r\n\t\t} else if (op === IPCEvents.REQUEST) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.client.ipcPieces.run(message)\r\n\t\t\t} catch (error) {\r\n\t\t\t\tmessage.reply({ success: false, d: { name: error.name, message: error.message, stack: error.stack }, route });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"],"sourceRoot":"../../src"}