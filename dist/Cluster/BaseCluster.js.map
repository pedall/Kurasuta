{"version":3,"sources":["../src/Cluster/BaseCluster.ts"],"names":[],"mappings":"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","file":"BaseCluster.js","sourcesContent":["import { ShardingManager } from '..';\r\nimport { Client, ClientOptions } from 'discord.js';\r\nimport { ShardClientUtil } from '../Sharding/ShardClientUtil';\r\nimport { IPCEvents } from '../Util/Constants';\r\nimport * as Util from '../Util/Util';\r\n\r\nexport interface CloseEvent {\r\n\tcode: number;\r\n\treason: string;\r\n\twasClean: boolean;\r\n}\r\n\r\nexport abstract class BaseCluster {\r\n\tpublic readonly client: Client;\r\n\tpublic readonly id: number;\r\n\r\n\tconstructor(public manager: ShardingManager) {\r\n\t\tconst env = process.env;\r\n\t\tconst shards = env.CLUSTER_SHARDS!.split(',').map(Number);\r\n\t\tconst clientConfig: ClientOptions = Util.mergeDefault<ClientOptions>(manager.clientOptions, {\r\n\t\t\tshards,\r\n\t\t\tshardCount: shards.length,\r\n\t\t\ttotalShardCount: Number(env.CLUSTER_SHARD_COUNT)\r\n\t\t});\r\n\t\tthis.client = new manager.client(clientConfig);\r\n\t\tconst client: any = this.client;\r\n\t\tclient.shard = new ShardClientUtil(client, manager.ipcSocket);\r\n\t\tthis.id = Number(env.CLUSTER_ID);\r\n\t}\r\n\r\n\tpublic async init(): Promise<void> {\r\n\t\tconst shardUtil = ((this.client.shard as any) as ShardClientUtil);\r\n\t\tawait shardUtil.init();\r\n\t\tthis.client.once('ready', () => shardUtil.send({ op: IPCEvents.READY, d: this.id }, { receptive: false }));\r\n\t\tthis.client.on('shardReady', (id: number) => shardUtil.send({ op: IPCEvents.SHARDREADY, d: { id: this.id, shardID: id } }, { receptive: false }));\r\n\t\tthis.client.on('reconnecting', (id: number) => shardUtil.send({ op: IPCEvents.SHARDRECONNECT, d: { id: this.id, shardID: id } }, { receptive: false }));\r\n\t\tthis.client.on('resumed', (replayed: number, id: number ) => shardUtil.send({ op: IPCEvents.SHARDRESUMED, d: { id: this.id, shardID: id, replayed } }, { receptive: false }));\r\n\t\tthis.client.on('disconnect', (closeEvent: CloseEvent, id: number) => shardUtil.send({ op: IPCEvents.SHARDDISCONNECT, d: { id: this.id, shardID: id, closeEvent } }, { receptive: false }));\r\n\t\tawait this.launch();\r\n\t}\r\n\r\n\tprotected abstract launch(): Promise<void>;\r\n}\r\n"],"sourceRoot":"../../src"}